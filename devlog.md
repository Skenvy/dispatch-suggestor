# Devlog
This is motivated by forgetting several times to test a branch deployment by dispatching its workflow, that would otherwise trigger from a push on the trunk, when working in repositories that followed a pattern of only deploying from non-trunk branches when manually dispatched. Hence the summary of what this tries to do is;
> Suggests dispatchable workflows for a branch that would otherwise trigger the dispatchable workflows from pushes to the trunk.

## Start making a node action
I've made a docker based action in the past but it'd be nice to try making a node based action. We can start with the github docs [Creating a JavaScript action](https://docs.github.com/en/actions/creating-actions/creating-a-javascript-action). It's also good to keep on hand a link to [Metadata syntax for GitHub Actions](https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions).

Something that can be seen quickly from this doc is that we'll need to build a single dist file from our source, using something like `npx ncc build src/index.ts --license licenses.txt` to build `dist/` which uses [vercel/ncc](https://github.com/vercel/ncc) to bundle our source and dependent code from `node_modules` into the single dist file.

[Understanding the risk of script injections](https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions#understanding-the-risk-of-script-injections)
## Using the typescript-action template
[Create a GitHub Action Using TypeScript](https://github.com/actions/typescript-action)

I first initialiased this back in May 2024 but didn't create it back then, so initially it was using [this](https://github.com/actions/typescript-action/tree/c55649f1894ca3da34f7e38d40fa103ce865044a) state of the `typescript-action` template. It looks like it's changed a lot in the year since, so we may as well update this to the [current](https://github.com/actions/typescript-action/tree/1e68449593284f2ee5ffd6679abb32f9e222b3bb) version. A small but significant detail that changed is it's now using [rollup/rollup](https://github.com/rollup/rollup) instead of [vercel/ncc](https://github.com/vercel/ncc) to handle bundling the dist.

**This paragraph is a rant**. Very quickly, something as simple as trying to re-introduce the `inclusion of the licenses of the dependency modules` in the output dist e.g. a bundled `dist/licenses.txt`, starts popping up error after error after error with `rollup` not being happy importing interfaces and struggling to work with typescript, and reminds me that doing anything other than the basic examples in any JS/TS development will quickly turn into a minefield. I.e. in the course of trying to learn why `rollup` wasn't happy with importing a particular interface from a plugin, and googling any of the several variety of `(Note that you need plugins to import files that are not JavaScript)` errors resulted in a cornucopia of SO posts and blog posts outlining various settings in the `tsconfig`, setting the `tsconfig` option on `rollup`'s `plugin-typescript` to a custom one, or swapping between multiple interations of other implementations of the `'@rollup/plugin-typescript'` package. _Adding a plugin to rollup shouldn't take hours of reading SO posts to try understand why it yields several different errors progressively_. As a fresh example -- I keep getting `(!) [plugin typescript] @rollup/plugin-typescript: Rollup 'sourcemap' option must be set to generate source maps.` which seems to have a whole bunch of hits with many answers that don't seem to make the warning go away or even get `rollup` to actually create the sourcemap, and visitng [rollup's cli docs](https://rollupjs.org/command-line-interface/#configplugin-plugin) after seeing the `--configPlugin @rollup/plugin-typescript` in the `package.json`'s `scripts`, and reading from the docs that;
> Note for Typescript: make sure you have the Rollup config file in your `tsconfig.json`'s `include` paths. For example:
> ```
> "include": ["src/**/*", "rollup.config.ts"],
> ```
and doing what the docs say, instead of fixing anything or even managing to just work without causing more issues, throws 10 new errors on the next `npm run bundle`. I regret putting in time to update from [vercel/ncc](https://github.com/vercel/ncc), which just worked without hours of trying to figure out what is wrong with it.

TLDR rollup has been so frustrating to setup as part of this template I ended up raising two issues on the `actions/typescript-template`, [#1010](https://github.com/actions/typescript-action/issues/1010) and [#1011](https://github.com/actions/typescript-action/issues/1011) (which refs the fix [rollup/plugins #1805](https://github.com/rollup/plugins/issues/1805)).
